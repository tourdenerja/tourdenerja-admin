<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tour de Nerja – Admin</title>

<style>
:root{
  --bg:#0a0a0b;
  --text:#f4f4f5;
  --muted:#a1a1aa;
  --line:rgba(255,255,255,.12);
  --surface:rgba(255,255,255,.03);
  --radius:22px;
  --max:1080px;
  --header-h:56px;

  --ok:#16a34a;
  --danger:#b91c1c;
  --danger-bg:rgba(185,28,28,.14);
  --danger-line:rgba(185,28,28,.35);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

a{color:inherit;text-decoration:none}

.wrap{
  max-width:var(--max);
  margin:0 auto;
  padding:22px 18px 80px;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  height:var(--header-h);
  background:rgba(10,10,11,.78);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);
  overflow:visible;
}

.top{
  position:relative;
  max-width:var(--max);
  height:100%;
  margin:0 auto;
  padding:0 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.brand{
  position:absolute;
  left:18px;
  top:0;
  z-index:3;
}

.logo{
  height:100px;
  width:auto;
  display:block;
  position:relative;
  top:18px;
}

nav{
  display:flex;
  gap:10px;
  margin-left:140px;
  align-items:center;
}

nav a{
  padding:10px 12px;
  border-radius:16px;
  color:var(--muted);
  white-space:nowrap;
}
nav a:hover{background:rgba(255,255,255,.06);color:var(--text)}
nav a.is-active{background:rgba(255,255,255,.06);color:var(--text)}

.btn{
  font-family:inherit;
  padding:10px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:700;
  white-space:nowrap;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.btn:hover{filter:brightness(1.06)}
.btn.ok{
  border-color:rgba(22,163,74,.45);
  background:rgba(22,163,74,.18);
}
.btn.danger{
  border-color:var(--danger-line);
  background:var(--danger-bg);
}

.auth{display:flex;align-items:center;gap:10px}
.nav-status{
  padding:0;border:0;background:none;color:var(--ok);
  white-space:nowrap;font-size:.95rem;font-weight:600;
}

.grid{
  margin-top:18px;
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:14px;
}

.block{
  grid-column:span 12;
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:var(--surface);
  padding:16px;
}

.tabs{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.tabbtn{
  padding:10px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:700;
  cursor:pointer;
}
.tabbtn.is-active{background:rgba(255,255,255,.10)}
.panel{display:none}
.panel.is-active{display:block}

.section-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.section-title{
  color:var(--muted);
  font-size:.92rem;
  font-weight:800;
}

.list{display:grid;gap:10px}
.item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.14);
}
.left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.name{
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.dot{
  width:12px;height:12px;border-radius:999px;
  background:rgba(255,255,255,.22);
  flex:0 0 auto;
}
.right{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.small{padding:8px 10px;border-radius:14px;font-weight:700}

select{
  font-family:inherit;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.88);
  color:#000;
  outline:none;
  min-width:170px;
}
select option{color:#000;background:#fff}

.readonly-value{
  width:100%;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.88);
  color:#000;
  font-weight:400;
}

.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
  padding:18px;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(8px);
}
.modal.is-open{display:flex}
.modal-panel{
  width:min(560px,100%);
  border:1px solid var(--line);
  border-radius:22px;
  background:rgba(10,10,11,.86);
  box-shadow:0 12px 40px rgba(0,0,0,.55);
  overflow:hidden;
}
.modal-head{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.modal-head strong{font-weight:900}
.modal-body{
  padding:14px 16px;
  display:grid;
  gap:12px;
  max-height:60vh;
  overflow-y:auto;
}
.field{display:flex;flex-direction:column;gap:8px}
label{font-size:.9rem;color:var(--muted)}
input[type="text"], input[type="date"], input[type="time"], input[type="number"]{
  font-family:inherit;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  color:var(--text);
  outline:none;
}
input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="number"]:focus{border-color:rgba(255,255,255,.22)}
.color-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:12px 12px;
  background:rgba(0,0,0,.14);
}
input[type="color"]{
  width:54px;height:44px;border:0;padding:0;background:transparent;cursor:pointer;
}
.modal-actions{
  padding:14px 16px;
  border-top:1px solid rgba(255,255,255,.08);
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}

@media(max-width:720px){
  .logo{height:64px;top:10px}
  nav{margin-left:92px}
}

.hole-ledger{
  display:grid;
  grid-template-columns:repeat(18, minmax(0,1fr));
  gap:6px;
  margin-top:10px;
}
.hole-cell{
  height:30px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.78rem;
  font-weight:400;
  cursor:pointer;
  user-select:none;
  color: var(--text);
}
.hole-cell:hover{filter:brightness(1.06)}
.hole-cell.is-empty{opacity:.8}
.hole-cell.is-booked{color:#000}
.hole-cell.is-half{background:#d4d4d8;color:#000}

.hole-row{
  display:grid;
  grid-template-columns:repeat(18, 10px);
  gap:4px;
  align-items:center;
  margin-top:6px;
}
.hole-dot{
  width:10px;height:10px;border-radius:4px;
  background:rgba(255,255,255,.18);
}
.hole-dot.half{background:rgba(255,255,255,.35)}

.hole-resultline{
  margin-top:8px;
  color:var(--muted);
  font-size:.92rem;
  font-weight:400;
}

.table-wrap{padding:0;margin:0;background:transparent;border:0}
.scoretable{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border:0;
  background:transparent;
  font-variant-numeric: tabular-nums;
}
.tiebreak-note{
  margin-top:10px;
  color:var(--muted);
  font-size:.80rem;
  font-weight:600;
  text-align:left;
}
.scoretable th, .scoretable td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  font-size:.95rem;
  background:transparent;
  text-align:center;
}
.scoretable thead th{color:var(--muted);font-weight:700}
.scoretable tbody tr:last-child td{border-bottom:0}
.scoretable th:first-child,.scoretable td:first-child{text-align:left}

#lagStatsBlock .scoretable, #playerStatsBlock .scoretable{table-layout:fixed}
#lagStatsBlock .scoretable th:first-child, #lagStatsBlock .scoretable td:first-child{width: 26%}
#lagStatsBlock .scoretable th:not(:first-child), #lagStatsBlock .scoretable td:not(:first-child){width: calc(74% / 6)}
#playerStatsBlock .scoretable th:first-child, #playerStatsBlock .scoretable td:first-child{width: 26%}
#playerStatsBlock .scoretable th:not(:first-child), #playerStatsBlock .scoretable td:not(:first-child){width: calc(74% / 14)}
#playerStatsBlock thead th{white-space:normal;word-break:break-word;overflow-wrap:anywhere;line-height:1.15;padding-top:8px;padding-bottom:8px}

.team-dot{
  display:inline-block;
  width:10px;height:10px;border-radius:999px;
  margin-right:8px;vertical-align:middle;
  border:1px solid rgba(255,255,255,.25);
}

.editor-toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin:10px 0 10px;
}
.editor-btn{
  padding:8px 10px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:800;
  cursor:pointer;
  user-select:none;
}
.editor-select{
  font-family:inherit;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:800;
  cursor:pointer;
  outline:none;
}
.editor-select:hover{filter:brightness(1.06)}
.editor-select option{
  color:#000;
  background:#fff;
}
.editor-btn:hover{filter:brightness(1.06)}
.editor-sep{
  width:1px;
  background:rgba(255,255,255,.10);
  margin:0 4px;
}
.editor{
  min-height:160px;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  color:var(--text);
  outline:none;
  line-height:1.45;
}
.editor:focus{border-color:rgba(255,255,255,.22)}
.editor p{margin:0 0 10px}
.editor h2{margin:8px 0 10px;font-size:1.05rem}
.editor ul,.editor ol{margin:0 0 10px 18px}
.editor a{color:#c7d2fe;text-decoration:underline}
.editor-hint{
  margin-top:10px;
  color:var(--muted);
  font-size:.88rem;
  font-weight:600;
}
</style>
</head>

<body>
<header>
  <div class="top">
    <a class="brand" href="index.html"><img class="logo" src="tour-de-nerja-logo.png" alt=""></a>

    <nav aria-label="Meny">
      <a href="index.html#tourdenerja">Tour de Nerja</a>
      <a href="index.html#statistik">Statistik</a>
      <a href="index.html#competitionInfoBlock">Tävlingsinformation</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="tabs" role="tablist" aria-label="Adminflikar">
    <button class="tabbtn is-active" type="button" role="tab" aria-selected="true" aria-controls="panel-players" id="tab-players">
      Lag/spelare
    </button>

    <button class="tabbtn" type="button" role="tab" aria-selected="false" aria-controls="panel-competition" id="tab-competition">
      Tävling/Statistik
    </button>
  </div>

  <section class="grid">
    <section class="block">
      <div class="panel is-active" role="tabpanel" id="panel-players" aria-labelledby="tab-players">
        <div class="section-head">
          <div class="section-title">Lag (max 2)</div>
          <div class="right">
            <button class="btn" type="button" id="toggleAllTeamsBtn">Dölj alla</button>
            <button class="btn" type="button" id="addTeamBtn">Lägg till lag</button>
          </div>
        </div>
        <div class="list" id="teamList"></div>

        <div style="height:1px;background:var(--line);margin:18px 0" aria-hidden="true"></div>
      </div>

      <div class="panel" role="tabpanel" id="panel-competition" aria-labelledby="tab-competition">
        <div class="section-head">
          <div class="section-title">Ronder</div>
          <div class="right">
            <button class="btn" type="button" id="toggleAllRoundsBtn">Dölj alla</button>
            <button class="btn" type="button" id="addRoundBtn">Lägg till runda</button>
          </div>
        </div>
        <div class="list" id="roundList"></div>
      </div>
    </section>

    <section class="block" id="lagStatsBlock" style="display:none">
      <div class="section-head" style="margin-bottom:12px">
        <div class="section-title">Lagstatistik</div>
      </div>

      <div class="table-wrap">
        <table class="scoretable">
          <thead>
            <tr>
              <th title="Lag">Lag</th>
              <th title="Spelade matcher">SM</th>
              <th title="Parmatchvinster">PV</th>
              <th title="Singelmatchvinster">SV</th>
              <th title="Delade matcher">D</th>
              <th title="Förlorade matcher">F</th>
              <th title="Matchhålvinstskillnad">+</th>
              <th title="Poäng">P</th>
            </tr>
          </thead>
          <tbody id="lagStatsBody"></tbody>
        </table>
      </div>
      <div class="tiebreak-note">
        Vid lika poäng avgör:
        <br>1) Matchhålvinstskillnad (+).
        <br>2) Flest vunna singelmatcher (SV).
      </div>
    </section>

    <section class="block" id="playerStatsBlock" style="display:none">
      <div class="section-head" style="margin-bottom:12px">
        <div class="section-title">Spelarstatistik</div>
      </div>

      <div class="table-wrap">
        <table class="scoretable">
          <thead>
            <tr>
              <th title="Spelare">Spelare</th>
              <th title="Spelade matcher">SM</th>
              <th title="Parmatchvinster">PV</th>
              <th title="Singelmatchvinster">SV</th>
              <th title="Delade matcher">D</th>
              <th title="Förlorade matcher">F</th>
              <th title="Birdies">B</th>
              <th title="Eagles">E</th>
              <th title="Albatross">A</th>
              <th title="Hole in One">HIO</th>
              <th title="Närmast flagg">NF</th>
              <th title="Längsta drive">LD</th>
              <th title="Poäng">P</th>
              <th title="Finalfördel">FF</th>
            </tr>
          </thead>
          <tbody id="playerStatsBody"></tbody>
        </table>
      </div>
      <div class="tiebreak-note">
        Vid lika poäng avgör:
        <br>1) Flest singelmatchvinster (SV).
        <br>2) Flest parmatchvinster (PV).
        <br>3) Flest albatross (A).
        <br>4) Flest HIO.
        <br>5) Flest eagles (E).
        <br>6) Flest birdies (B).
      </div>
    </section>


    <section class="block" id="competitionInfoBlock" style="display:none">
      <div class="section-head" style="margin-bottom:12px">
        <div class="section-title">Tävlingsinformation</div>
        <div class="right">
          <button class="btn small" type="button" id="compInfoClearBtn">Rensa</button>
          <button class="btn ok small" type="button" id="compInfoSaveBtn">Spara</button>
        </div>
      </div>

      <div class="editor-toolbar" role="toolbar" aria-label="Textverktyg">
        <button class="editor-btn" type="button" data-cmd="bold"><b>B</b></button>
        <button class="editor-btn" type="button" data-cmd="italic"><i>I</i></button>
        <button class="editor-btn" type="button" data-cmd="underline"><u>U</u></button>

        <span class="editor-sep" aria-hidden="true"></span>

        <button class="editor-btn" type="button" data-cmd="formatBlock" data-arg="H2">H2</button>
        <button class="editor-btn" type="button" data-cmd="formatBlock" data-arg="P">P</button>

        <span class="editor-sep" aria-hidden="true"></span>

        <select id="compInfoFontSize" class="editor-select" aria-label="Textstorlek">
          <option value="">Storlek</option>
          <option value="12px">12</option>
          <option value="14px">14</option>
          <option value="16px">16</option>
          <option value="18px">18</option>
          <option value="20px">20</option>
          <option value="24px">24</option>
          <option value="28px">28</option>
          <option value="32px">32</option>
        </select>

        <button class="editor-btn" type="button" data-cmd="insertUnorderedList">• Lista</button>
        <button class="editor-btn" type="button" data-cmd="insertOrderedList">1. Lista</button>

        <span class="editor-sep" aria-hidden="true"></span>

        <button class="editor-btn" type="button" data-cmd="justifyLeft">⟸</button>
        <button class="editor-btn" type="button" data-cmd="justifyCenter">≡</button>
        <button class="editor-btn" type="button" data-cmd="justifyRight">⟹</button>

        <span class="editor-sep" aria-hidden="true"></span>

        <button class="editor-btn" type="button" id="compInfoLinkBtn">Länk</button>
        <button class="editor-btn" type="button" data-cmd="removeFormat">Rensa format</button>
      </div>

      <div id="competitionInfoEditor" class="editor" contenteditable="true" spellcheck="true"
           aria-label="Tävlingsinformation (fritext)"></div>
      </div>
    </section>

  </section>
</main>

<div class="modal" id="teamModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel">
    <div class="modal-head">
      <strong id="teamModalTitle">Lägg till lag</strong>
      <button class="btn" type="button" data-close="teamModal">Avbryt</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label for="teamName">Lagnamn</label>
        <input id="teamName" type="text" />
      </div>
      <div class="color-row">
        <div>
          <div style="font-size:.9rem;color:var(--muted);margin-bottom:6px">Lagfärg</div>
          <div style="font-size:.92rem;color:var(--muted)">Används i publikläge</div>
        </div>
        <input id="teamColor" type="color" value="#7c1d1d" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close="teamModal">Avbryt</button>
      <button class="btn" type="button" id="saveTeamBtn">Spara</button>
    </div>
  </div>
</div>

<div class="modal" id="playerModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel">
    <div class="modal-head">
      <strong id="playerModalTitle">Lägg till spelare</strong>
      <button class="btn" type="button" data-close="playerModal">Avbryt</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label for="playerName">Spelarnamn</label>
        <input id="playerName" type="text" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close="playerModal">Avbryt</button>
      <button class="btn" type="button" id="savePlayerBtn">Spara</button>
    </div>
  </div>
</div>

<div class="modal" id="roundModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel">
    <div class="modal-head">
      <strong id="roundModalTitle">Lägg till runda</strong>
      <button class="btn" type="button" data-close="roundModal">Avbryt</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label for="roundCourse">Bana</label>
        <input id="roundCourse" type="text" />
      </div>
      <div class="field">
        <label for="roundDate">Datum</label>
        <input id="roundDate" type="date" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close="roundModal">Avbryt</button>
      <button class="btn" type="button" id="saveRoundBtn">Spara</button>
    </div>
  </div>
</div>

<div class="modal" id="matchModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel">
    <div class="modal-head">
      <strong id="matchModalTitle">Lägg till match</strong>
      <button class="btn" type="button" data-close="matchModal">Avbryt</button>
    </div>

    <div class="modal-body">
      <div class="field">
        <label for="matchType">Typ</label>
        <select id="matchType">
          <option value="Singel">Singel</option>
          <option value="Par">Par (Bästboll)</option>
        </select>
      </div>

      <div class="field">
        <label for="matchValue">Värde individuellt</label>
        <select id="matchValue">
          <option value="5">5</option>
          <option value="7">7</option>
        </select>
      </div>

      <div class="field">
        <label for="teamAPlayer1" id="lblA1">Spelare lag A</label>
        <select id="teamAPlayer1"></select>
      </div>

      <div class="field" id="teamAPlayer2Field">
        <label for="teamAPlayer2" id="lblA2">Spelare lag A (2)</label>
        <select id="teamAPlayer2"></select>
      </div>

      <div class="field">
        <label for="teamBPlayer1" id="lblB1">Spelare lag B</label>
        <select id="teamBPlayer1"></select>
      </div>

      <div class="field" id="teamBPlayer2Field">
        <label for="teamBPlayer2" id="lblB2">Spelare lag B (2)</label>
        <select id="teamBPlayer2"></select>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn" type="button" data-close="matchModal">Avbryt</button>
      <button class="btn" type="button" id="saveMatchBtn">Spara</button>
    </div>
  </div>
</div>

<div class="modal" id="bookModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel">
    <div class="modal-head">
      <strong id="bookModalTitle">Bokför match</strong>
      <button class="btn" type="button" data-close="bookModal">Avbryt</button>
    </div>

    <div class="modal-body">
      <div style="color:var(--muted);font-size:.92rem;font-weight:400">Hål-för-hål (matchspel)</div>
      <div id="holeLedgerArea"></div>
      <div class="hole-resultline" id="holeResultLine"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <button class="btn small" type="button" id="clearHolesBtn">Rensa hål</button>
      </div>

      <div style="height:1px;background:var(--line);margin:10px 0" aria-hidden="true"></div>

      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="field" style="margin:0;min-width:220px">
          <label>Vinnare</label>
          <div class="readonly-value" id="bookWinnerText">—</div>
        </div>

        <div class="field" style="margin:0;min-width:220px">
          <label>Matchen avgjordes på hål</label>
          <div class="readonly-value" id="bookWonOnHoleText">—</div>
        </div>
      </div>

      <div style="height:1px;background:var(--line);margin:10px 0" aria-hidden="true"></div>

      <div style="color:var(--muted);font-size:.92rem;font-weight:400">Individuella poäng</div>
      <div id="bookPlayersList" class="list"></div>
    </div>

    <div class="modal-actions">
      <button class="btn" type="button" data-close="bookModal">Avbryt</button>
      <button class="btn" type="button" id="saveBookBtn">Spara</button>
      <button class="btn ok" type="button" id="closeMatchBtn">Avsluta match</button>
    </div>
  </div>
</div>

<script>
(function(){
  const KEY = 'tdn_admin_state_v2';

  const teamList = document.getElementById('teamList');
  const roundList = document.getElementById('roundList');

  const teamModal = document.getElementById('teamModal');
  const playerModal = document.getElementById('playerModal');
  const roundModal = document.getElementById('roundModal');
  const matchModal = document.getElementById('matchModal');
  const bookModal = document.getElementById('bookModal');

  const teamModalTitle = document.getElementById('teamModalTitle');
  const playerModalTitle = document.getElementById('playerModalTitle');
  const roundModalTitle = document.getElementById('roundModalTitle');
  const matchModalTitle = document.getElementById('matchModalTitle');
  const bookModalTitle = document.getElementById('bookModalTitle');

  const teamName = document.getElementById('teamName');
  const teamColor = document.getElementById('teamColor');
  const playerName = document.getElementById('playerName');
  const roundDate = document.getElementById('roundDate');
  const roundCourse = document.getElementById('roundCourse');

  const matchType = document.getElementById('matchType');
  const matchValue = document.getElementById('matchValue');
  const teamAPlayer1 = document.getElementById('teamAPlayer1');
  const teamAPlayer2 = document.getElementById('teamAPlayer2');
  const teamBPlayer1 = document.getElementById('teamBPlayer1');
  const teamBPlayer2 = document.getElementById('teamBPlayer2');
  const teamAPlayer2Field = document.getElementById('teamAPlayer2Field');
  const teamBPlayer2Field = document.getElementById('teamBPlayer2Field');
  const saveMatchBtn = document.getElementById('saveMatchBtn');

  const bookWinnerText = document.getElementById('bookWinnerText');
  const bookWonOnHoleText = document.getElementById('bookWonOnHoleText');
  const bookPlayersList = document.getElementById('bookPlayersList');
  const clearHolesBtn = document.getElementById('clearHolesBtn');
  const saveBookBtn = document.getElementById('saveBookBtn');
  const closeMatchBtn = document.getElementById('closeMatchBtn');

  const saveTeamBtn = document.getElementById('saveTeamBtn');
  const savePlayerBtn = document.getElementById('savePlayerBtn');
  const saveRoundBtn = document.getElementById('saveRoundBtn');

  const competitionInfoBlock = document.getElementById('competitionInfoBlock');
  const competitionInfoEditor = document.getElementById('competitionInfoEditor');
  const compInfoSaveBtn = document.getElementById('compInfoSaveBtn');
  const compInfoClearBtn = document.getElementById('compInfoClearBtn');
  const compInfoLinkBtn = document.getElementById('compInfoLinkBtn');

  (function(){
    if(!roundDate) return;
    const openPicker = () => { if(typeof roundDate.showPicker === 'function') roundDate.showPicker(); };
    roundDate.addEventListener('click', openPicker);
    roundDate.addEventListener('focus', openPicker);
  })();

  let editingTeamId = null;
  let editingPlayerId = null;
  let editingRoundId = null;

  let expandedTeams = {};   // { [teamId]: boolean }
  let expandedRounds = {};  // { [roundId]: boolean }

  let addingPlayerTeamId = '';

  let currentMatchRoundId = null;
  let editingMatchId = null;

  let bookingMatchId = null;
  let bookingHolesDraft = null;

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return {teams:[], players:[], rounds:[], matches:[], competitionInfoHtml:''};
      const d = JSON.parse(raw);
      if(!d || typeof d !== 'object') return {teams:[], players:[], rounds:[], matches:[], competitionInfoHtml:''};
      d.teams = Array.isArray(d.teams) ? d.teams : [];
      d.players = Array.isArray(d.players) ? d.players : [];
      d.rounds = Array.isArray(d.rounds) ? d.rounds : [];
      d.matches = Array.isArray(d.matches) ? d.matches : [];
      d.competitionInfoHtml = (typeof d.competitionInfoHtml === 'string') ? d.competitionInfoHtml : '';
      return sanitizeState(d);
    }catch(e){
      return {teams:[], players:[], rounds:[], matches:[], competitionInfoHtml:''};
    }
  }

  function save(state){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function sanitizeState(state){
    state = state && typeof state === 'object'
      ? state
      : {teams:[], players:[], rounds:[], matches:[], competitionInfoHtml:''};

    state.teams = Array.isArray(state.teams) ? state.teams : [];
    state.players = Array.isArray(state.players) ? state.players : [];
    state.rounds = Array.isArray(state.rounds) ? state.rounds : [];
    state.matches = Array.isArray(state.matches) ? state.matches : [];
    state.competitionInfoHtml = (typeof state.competitionInfoHtml === 'string') ? state.competitionInfoHtml : '';

    const validTeams = new Set(state.teams.map(t => t && t.id).filter(Boolean));
    state.players = state.players.filter(p => p && validTeams.has(p.teamId));

    const validPlayers = new Set(state.players.map(p => p && p.id).filter(Boolean));

    state.matches.forEach(m => {
      if(!m) return;

      m.teamA = (Array.isArray(m.teamA) ? m.teamA : []).filter(pid => validPlayers.has(pid));
      m.teamB = (Array.isArray(m.teamB) ? m.teamB : []).filter(pid => validPlayers.has(pid));

      if(m.book && m.book.byPlayer && typeof m.book.byPlayer === 'object'){
        Object.keys(m.book.byPlayer).forEach(pid => {
          if(!validPlayers.has(pid)) delete m.book.byPlayer[pid];
        });
      }

      const aOk = m.teamA.length > 0;
      const bOk = m.teamB.length > 0;
      if(!aOk || !bOk){
        m.isClosed = false;
        m.holes = Array(18).fill(null);
        delete m.book;
      }
    });

    return state;
  }

  function openModal(el){
    el.classList.add('is-open');
    el.setAttribute('aria-hidden','false');
  }

  function closeModal(el){
    el.classList.remove('is-open');
    el.setAttribute('aria-hidden','true');
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-close]');
    if(btn){
      const id = btn.getAttribute('data-close');
      const m = document.getElementById(id);
      if(m) closeModal(m);
    }
    if(e.target.classList.contains('modal')) closeModal(e.target);
  });

  document.addEventListener('keydown', (e) => {
    if(e.key !== 'Escape') return;
    [teamModal, playerModal, roundModal, matchModal, bookModal].forEach(m => {
      if(m.classList.contains('is-open')) closeModal(m);
    });
  });

  function getTeamsAB(state){
    const teams = Array.isArray(state?.teams) ? state.teams : [];
    return { A: teams[0] || null, B: teams[1] || null };
  }

  function teamColorById(state, id){
    const t = state.teams.find(x => x.id === id);
    return t ? (t.color || 'rgba(255,255,255,.22)') : 'rgba(255,255,255,.22)';
  }

  function playerNameById(state, id){
    const p = state.players.find(x => x.id === id);
    return p ? p.name : '';
  }

  function contrastTextColor(bg){
    const c = String(bg || '').trim();
    if(!c.startsWith('#')) return '#000';

    let r,g,b;
    if(c.length === 4){
      r = parseInt(c[1]+c[1],16);
      g = parseInt(c[2]+c[2],16);
      b = parseInt(c[3]+c[3],16);
    }else if(c.length === 7){
      r = parseInt(c.slice(1,3),16);
      g = parseInt(c.slice(3,5),16);
      b = parseInt(c.slice(5,7),16);
    }else{
      return '#000';
    }

    const srgb = [r,g,b].map(v => {
      const x = v/255;
      return x <= 0.03928 ? x/12.92 : Math.pow((x+0.055)/1.055, 2.4);
    });
    const L = 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
    return (L > 0.52) ? '#000' : '#fff';
  }

  function formatDate(iso){ return iso || ''; }

  function isTeamOpen(id){ return (expandedTeams[id] !== undefined) ? !!expandedTeams[id] : true; }
  function isRoundOpen(id){ return (expandedRounds[id] !== undefined) ? !!expandedRounds[id] : true; }

  function setAllTeamsOpen(state, open){ (state.teams || []).forEach(t => expandedTeams[t.id] = !!open); }
  function setAllRoundsOpen(state, open){ (state.rounds || []).forEach(r => expandedRounds[r.id] = !!open); }

  function syncToggleButtons(state){
    const tTeams = document.getElementById('toggleAllTeamsBtn');
    const teams = Array.isArray(state?.teams) ? state.teams : [];
    if(tTeams){
      if(teams.length === 0){
        tTeams.style.display = 'none';
      }else{
        tTeams.style.display = '';
        const allOpen = teams.every(t => isTeamOpen(t.id) === true);
        if(allOpen){ tTeams.textContent = 'Dölj alla'; tTeams.dataset.mode = 'collapse'; }
        else { tTeams.textContent = 'Visa alla'; tTeams.dataset.mode = 'expand'; }
      }
    }

    const tRounds = document.getElementById('toggleAllRoundsBtn');
    const rounds = Array.isArray(state?.rounds) ? state.rounds : [];
    if(tRounds){
      if(rounds.length === 0){
        tRounds.style.display = 'none';
      }else{
        tRounds.style.display = '';
        const allOpen = rounds.every(r => isRoundOpen(r.id) === true);
        if(allOpen){ tRounds.textContent = 'Dölj alla'; tRounds.dataset.mode = 'collapse'; }
        else { tRounds.textContent = 'Visa alla'; tRounds.dataset.mode = 'expand'; }
      }
    }
  }

  function sortTeamsAndPlayers2Lag(state){
    state.teams = Array.isArray(state.teams) ? state.teams : [];
    const idx = {};
    state.teams.forEach((t,i) => idx[t.id] = i);

    state.players = Array.isArray(state.players) ? state.players.slice() : [];
    state.players.sort((a,b) => {
      const ia = (a.teamId in idx) ? idx[a.teamId] : 999;
      const ib = (b.teamId in idx) ? idx[b.teamId] : 999;
      if(ia !== ib) return ia - ib;
      if(!!a.isCaptain !== !!b.isCaptain) return a.isCaptain ? -1 : 1;
      return (a.name||'').localeCompare(b.name||'', 'sv');
    });
  }

  function nextMatchNo(state){
    const matches = Array.isArray(state.matches) ? state.matches : [];
    const maxNo = matches.reduce((mx, m) => Math.max(mx, Number(m.no) || 0), 0);
    return maxNo + 1;
  }

  function ensureHolesOnMatch(m){
    if(!m || typeof m !== 'object') return;
    if(!Array.isArray(m.holes) || m.holes.length !== 18) m.holes = Array(18).fill(null);
  }

  function cloneHoles(holes){
    if(!Array.isArray(holes)) return Array(18).fill(null);
    return holes.slice(0,18).map(v => (v === 'A' || v === 'B' || v === 'H') ? v : null);
  }

  function cycleHoleValue(v){
    if(v == null) return 'A';
    if(v === 'A') return 'H';
    if(v === 'H') return 'B';
    return null;
  }

  function computeMatchResultText(holes){
    const h = Array.isArray(holes) ? holes : [];
    let a = 0, b = 0, played = 0;
    for(let i=0;i<18;i++){
      const v = (i < h.length) ? h[i] : null;
      if(v === 'A'){ a++; played++; }
      else if(v === 'B'){ b++; played++; }
      else if(v === 'H'){ played++; }
    }
    const remaining = 18 - played;
    const diff = a - b;
    const absDiff = Math.abs(diff);

    if(absDiff > remaining) return absDiff + '&' + remaining;
    if(played === 18){
      if(diff === 0) return 'Tied';
      return absDiff + 'UP';
    }
    if(diff === 0) return 'AS (' + remaining + ')';
    return absDiff + 'UP (' + remaining + ')';
  }

  function computeOutcomeFromHoles(holes){
    const h = Array.isArray(holes) ? holes : [];
    let a = 0, b = 0, played = 0;
    let clinchHole = 0;
    let clinchUp = 0;
    let clinchY = 0;

    for(let i=0;i<18;i++){
      const v = (i < h.length) ? h[i] : null;
      if(v === 'A'){ a++; played++; }
      else if(v === 'B'){ b++; played++; }
      else if(v === 'H'){ played++; }
      else { continue; }

      const remaining = 18 - played;
      const diff = a - b;
      const absDiff = Math.abs(diff);

      if(!clinchHole && absDiff > remaining){
        clinchHole = i + 1;
        clinchUp = absDiff;
        clinchY = remaining;
      }
    }

    if(clinchHole){
      return {
        decided: true,
        winner: (a - b) > 0 ? 'A' : 'B',
        wonOnHole: clinchHole,
        resultUp: clinchUp,
        text: clinchUp + '&' + clinchY
      };
    }

    if(played === 18){
      if(a === b) return { decided: true, winner: 'D', wonOnHole: '', resultUp: 0, text: 'Tied' };
      return {
        decided: true,
        winner: (a - b) > 0 ? 'A' : 'B',
        wonOnHole: 18,
        resultUp: Math.abs(a - b),
        text: Math.abs(a - b) + 'UP'
      };
    }

    return { decided: false, winner: '', wonOnHole: '', resultUp: 0, text: computeMatchResultText(h) };
  }

  function renderHoleLedger(container, holesDraft, aColor, bColor, onChange){
    if(!container) return;
    if(!Array.isArray(holesDraft) || holesDraft.length !== 18) holesDraft = Array(18).fill(null);
    container.innerHTML = '';

    const grid = document.createElement('div');
    grid.className = 'hole-ledger';

    function paintCell(cell, v){
      cell.classList.remove('is-half','is-empty','is-booked');
      cell.style.background = 'rgba(255,255,255,.06)';
      cell.style.color = 'var(--text)';

      if(v == null){ cell.classList.add('is-empty'); return; }

      cell.classList.add('is-booked');
      if(v === 'A'){
        cell.style.background = aColor || 'rgba(255,255,255,.18)';
        cell.style.color = contrastTextColor(aColor);
      }else if(v === 'B'){
        cell.style.background = bColor || 'rgba(255,255,255,.18)';
        cell.style.color = contrastTextColor(bColor);
      }else if(v === 'H'){
        cell.classList.add('is-half');
        cell.style.background = '#d4d4d8';
        cell.style.color = '#000';
      }
    }

    for(let i=0;i<18;i++){
      const cell = document.createElement('div');
      cell.className = 'hole-cell';
      cell.textContent = String(i+1);
      paintCell(cell, holesDraft[i]);
      cell.addEventListener('click', () => {
        holesDraft[i] = cycleHoleValue(holesDraft[i]);
        paintCell(cell, holesDraft[i]);
        if(typeof onChange === 'function') onChange();
      });
      grid.appendChild(cell);
    }

    container.appendChild(grid);
  }

  function makeHoleRow(holes, aColor, bColor){
    const h = Array.isArray(holes) ? holes : [];
    const row = document.createElement('div');
    row.className = 'hole-row';
    for(let i=0;i<18;i++){
      const v = (i < h.length) ? h[i] : null;
      const d = document.createElement('span');
      d.className = 'hole-dot';
      if(v === 'A') d.style.background = aColor || 'rgba(255,255,255,.18)';
      else if(v === 'B') d.style.background = bColor || 'rgba(255,255,255,.18)';
      else if(v === 'H') d.classList.add('half');
      row.appendChild(d);
    }
    return row;
  }

  function getClosedWinnerAndHole(m){
    if(!m || !m.isClosed) return { winner:'', wonOnHole:0, resultUp:0 };
    const holes = Array.isArray(m.holes) ? m.holes : [];
    const anyPlayed = holes.some(v => v === 'A' || v === 'B' || v === 'H');
    if(anyPlayed){
      const out = computeOutcomeFromHoles(holes);
      if(out.decided){
        return {
          winner: out.winner,
          wonOnHole: Number(out.wonOnHole) || 0,
          resultUp: Number(out.resultUp) || 0
        };
      }
    }
    const w = String(m?.book?.winner || '');
    const h = Number(m?.book?.wonOnHole) || 0;
    const up = Number(m?.book?.resultUp) || 0;
    if(w === 'A' || w === 'B' || w === 'D') return { winner:w, wonOnHole:h, resultUp:up };
    return { winner:'', wonOnHole:0, resultUp:0 };
  }

  function applyTeamResult(A, B, winner, wonOnHole, matchType){
    if(winner === 'A'){
      B.L++;
      if(matchType === 'Par'){ A.W++; A.P += 1; }
      else if(matchType === 'Singel'){ A.S = (A.S || 0) + 1; A.P += 1; }
    }else if(winner === 'B'){
      A.L++;
      if(matchType === 'Par'){ B.W++; B.P += 1; }
      else if(matchType === 'Singel'){ B.S = (B.S || 0) + 1; B.P += 1; }
    }else if(winner === 'D'){
      A.D++; B.D++; A.P += 0.5; B.P += 0.5;
    }else{
      return;
    }

    if((winner === 'A' || winner === 'B') && wonOnHole >= 1 && wonOnHole <= 18){
      const delta = 19 - wonOnHole;
      if(winner === 'A') A.PM += delta;
      else B.PM += delta;
    }
  }

  function fillPlayerSelect(selectEl, players){
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = '—';
    selectEl.appendChild(opt0);

    players.forEach(p => {
      const o = document.createElement('option');
      o.value = p.id;
      o.textContent = p.name;
      selectEl.appendChild(o);
    });
  }

  function updateMatchUI(){
    const isPar = matchType.value === 'Par';
    teamAPlayer2Field.style.display = isPar ? '' : 'none';
    teamBPlayer2Field.style.display = isPar ? '' : 'none';
    if(!isPar){
      teamAPlayer2.value = '';
      teamBPlayer2.value = '';
    }
  }

  function openAddMatchForRound(roundId){
    const state = load();
    sortTeamsAndPlayers2Lag(state);

    editingMatchId = null;
    currentMatchRoundId = roundId;

    const r = state.rounds.find(x => x.id === roundId);
    const label = r ? ((formatDate(r.date) ? formatDate(r.date) + ' – ' : '') + (r.course || '')) : '';
    matchModalTitle.textContent = 'Lägg till match' + (label ? ' – ' + label : '');

    matchType.value = 'Singel';
    matchValue.value = '5';

    const { A: teamA, B: teamB } = getTeamsAB(state);

    const lblA1 = document.getElementById('lblA1');
    const lblA2 = document.getElementById('lblA2');
    const lblB1 = document.getElementById('lblB1');
    const lblB2 = document.getElementById('lblB2');

    const teamAName = teamA ? teamA.name : 'Lag A';
    const teamBName = teamB ? teamB.name : 'Lag B';

    if(lblA1) lblA1.textContent = `Spelare (${teamAName})`;
    if(lblA2) lblA2.textContent = `Spelare (${teamAName}) (2)`;
    if(lblB1) lblB1.textContent = `Spelare (${teamBName})`;
    if(lblB2) lblB2.textContent = `Spelare (${teamBName}) (2)`;

    const playersA = teamA ? state.players.filter(p => p.teamId === teamA.id) : [];
    const playersB = teamB ? state.players.filter(p => p.teamId === teamB.id) : [];

    fillPlayerSelect(teamAPlayer1, playersA);
    fillPlayerSelect(teamAPlayer2, playersA);
    fillPlayerSelect(teamBPlayer1, playersB);
    fillPlayerSelect(teamBPlayer2, playersB);

    updateMatchUI();
    openModal(matchModal);
    setTimeout(() => matchType.focus(), 0);
  }

  function openEditMatch(matchId){
    const state = load();
    sortTeamsAndPlayers2Lag(state);

    const m = state.matches.find(x => x.id === matchId);
    if(!m || m.isClosed) return;

    editingMatchId = matchId;
    currentMatchRoundId = m.roundId;

    const r = state.rounds.find(x => x.id === m.roundId);
    const label = r ? ((formatDate(r.date) ? formatDate(r.date) + ' – ' : '') + (r.course || '')) : '';
    matchModalTitle.textContent = 'Ändra match' + (label ? ' – ' + label : '');

    matchType.value = m.type;
    matchValue.value = String(m.value);

    const { A: teamA, B: teamB } = getTeamsAB(state);

    const lblA1 = document.getElementById('lblA1');
    const lblA2 = document.getElementById('lblA2');
    const lblB1 = document.getElementById('lblB1');
    const lblB2 = document.getElementById('lblB2');

    const teamAName = teamA ? teamA.name : 'Lag A';
    const teamBName = teamB ? teamB.name : 'Lag B';

    if(lblA1) lblA1.textContent = `Spelare (${teamAName})`;
    if(lblA2) lblA2.textContent = `Spelare (${teamAName}) (2)`;
    if(lblB1) lblB1.textContent = `Spelare (${teamBName})`;
    if(lblB2) lblB2.textContent = `Spelare (${teamBName}) (2)`;

    const playersA = teamA ? state.players.filter(p => p.teamId === teamA.id) : [];
    const playersB = teamB ? state.players.filter(p => p.teamId === teamB.id) : [];

    fillPlayerSelect(teamAPlayer1, playersA);
    fillPlayerSelect(teamAPlayer2, playersA);
    fillPlayerSelect(teamBPlayer1, playersB);
    fillPlayerSelect(teamBPlayer2, playersB);

    teamAPlayer1.value = m.teamA[0] || '';
    teamBPlayer1.value = m.teamB[0] || '';
    teamAPlayer2.value = m.teamA[1] || '';
    teamBPlayer2.value = m.teamB[1] || '';

    updateMatchUI();
    openModal(matchModal);
  }

  function openBookMatch(matchId){
    const state = load();
    sortTeamsAndPlayers2Lag(state);

    const m = state.matches.find(x => x.id === matchId);
    if(!m || m.isClosed) return;

    bookingMatchId = matchId;
    bookModalTitle.textContent = `Bokför match ${Number(m.no) || ''}`.trim();

    const { A: teamA, B: teamB } = getTeamsAB(state);
    const teamAName = teamA ? teamA.name : 'Lag A';
    const teamBName = teamB ? teamB.name : 'Lag B';

    if(bookWinnerText) bookWinnerText.textContent = '—';
    if(bookWonOnHoleText) bookWonOnHoleText.textContent = '—';

    const playersInMatch = [...(m.teamA || []), ...(m.teamB || [])].filter(Boolean);
    const byPlayer = (m.book && m.book.byPlayer && typeof m.book.byPlayer === 'object') ? m.book.byPlayer : {};

    bookPlayersList.innerHTML = '';

    const holeLedgerArea = document.getElementById('holeLedgerArea');
    const holeResultLine = document.getElementById('holeResultLine');

    ensureHolesOnMatch(m);
    bookingHolesDraft = cloneHoles(m.holes);

    const aColor = teamA ? teamColorById(state, teamA.id) : 'rgba(255,255,255,.22)';
    const bColor = teamB ? teamColorById(state, teamB.id) : 'rgba(255,255,255,.22)';

    const refreshHoleResult = () => {
      const outcome = computeOutcomeFromHoles(bookingHolesDraft);
      if(holeResultLine) holeResultLine.textContent = `Resultat: ${outcome.text}`;

      const anyPlayed = Array.isArray(bookingHolesDraft) && bookingHolesDraft.some(v => v === 'A' || v === 'B' || v === 'H');
      if(!anyPlayed){
        if(bookWinnerText) bookWinnerText.textContent = '—';
        if(bookWonOnHoleText) bookWonOnHoleText.textContent = '—';
        return;
      }

      if(outcome.decided){
        if(outcome.winner === 'D'){
          if(bookWinnerText) bookWinnerText.textContent = 'Delad match';
          if(bookWonOnHoleText) bookWonOnHoleText.textContent = '—';
        }else if(outcome.winner === 'A'){
          if(bookWinnerText) bookWinnerText.textContent = teamAName;
          if(bookWonOnHoleText) bookWonOnHoleText.textContent = String(outcome.wonOnHole || '');
        }else if(outcome.winner === 'B'){
          if(bookWinnerText) bookWinnerText.textContent = teamBName;
          if(bookWonOnHoleText) bookWonOnHoleText.textContent = String(outcome.wonOnHole || '');
        }
      }else{
        if(bookWinnerText) bookWinnerText.textContent = '—';
        if(bookWonOnHoleText) bookWonOnHoleText.textContent = '—';
      }
    };

    if(holeLedgerArea){
      renderHoleLedger(holeLedgerArea, bookingHolesDraft, aColor, bColor, refreshHoleResult);
    }
    refreshHoleResult();

    if(clearHolesBtn){
      clearHolesBtn.onclick = () => {
        bookingHolesDraft = Array(18).fill(null);
        if(holeLedgerArea){
          renderHoleLedger(holeLedgerArea, bookingHolesDraft, aColor, bColor, refreshHoleResult);
        }
        refreshHoleResult();
      };
    }

    function makeStepper(key, value, max){
      const wrap = document.createElement('div');
      wrap.style.display = 'grid';
      wrap.style.gridTemplateColumns = '44px 44px 44px';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '8px';
      wrap.style.width = '100%';

      const btnMinus = document.createElement('button');
      btnMinus.type = 'button';
      btnMinus.className = 'btn small';
      btnMinus.textContent = '−';
      btnMinus.style.padding = '8px 0';
      btnMinus.style.borderRadius = '12px';

      const inp = document.createElement('input');
      inp.type = 'number';
      inp.inputMode = 'numeric';
      inp.min = '0';
      inp.max = String(max);
      inp.step = '1';
      inp.pattern = '[0-9]*';
      inp.value = String(Math.max(0, Math.min(max, Number(value) || 0)));
      inp.setAttribute('data-stat', key);
      inp.setAttribute('data-max', String(max));
      inp.style.width = '44px';
      inp.style.padding = '10px 0';
      inp.style.borderRadius = '12px';
      inp.style.border = '1px solid var(--line)';
      inp.style.background = 'rgba(0,0,0,.18)';
      inp.style.color = 'var(--text)';
      inp.style.outline = 'none';
      inp.style.textAlign = 'center';
      inp.style.fontWeight = '700';

      const btnPlus = document.createElement('button');
      btnPlus.type = 'button';
      btnPlus.className = 'btn small';
      btnPlus.textContent = '+';
      btnPlus.style.padding = '8px 0';
      btnPlus.style.borderRadius = '12px';

      function clampAndSet(v){
        const n = Math.max(0, Math.min(max, Number(v) || 0));
        inp.value = String(n);
      }

      btnMinus.addEventListener('click', () => clampAndSet((Number(inp.value) || 0) - 1));
      btnPlus.addEventListener('click', () => clampAndSet((Number(inp.value) || 0) + 1));

      inp.addEventListener('input', () => clampAndSet(inp.value));
      inp.addEventListener('blur', () => clampAndSet(inp.value));

      wrap.appendChild(btnMinus);
      wrap.appendChild(inp);
      wrap.appendChild(btnPlus);
      return wrap;
    }

    function rowField(labelText, key, value, max){
      const wrap = document.createElement('div');
      wrap.className = 'field';
      wrap.style.margin = '0';
      wrap.style.minWidth = '140px';

      const lab = document.createElement('label');
      lab.textContent = labelText;

      const stepper = makeStepper(key, value, max);

      wrap.appendChild(lab);
      wrap.appendChild(stepper);
      return wrap;
    }

    playersInMatch.forEach(pid => {
      const item = document.createElement('div');
      item.className = 'item';
      item.style.alignItems = 'flex-start';

      const right = document.createElement('div');
      right.className = 'right';
      right.style.justifyContent = 'flex-end';
      right.style.width = '100%';

      const holder = document.createElement('div');
      holder.style.display = 'grid';
      holder.style.gridTemplateColumns = 'repeat(2, minmax(0, 1fr))';
      holder.style.gap = '10px';
      holder.style.width = 'min(520px, 100%)';
      holder.setAttribute('data-player', pid);

      const header = document.createElement('div');
      header.style.gridColumn = '1 / -1';
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.style.gap = '10px';
      header.style.marginBottom = '6px';

      const hdDot = document.createElement('span');
      hdDot.className = 'dot';
      const teamId = state.players.find(p => p.id === pid)?.teamId || '';
      hdDot.style.background = teamId ? teamColorById(state, teamId) : 'rgba(255,255,255,.22)';

      const hdName = document.createElement('div');
      hdName.className = 'name';
      hdName.textContent = playerNameById(state, pid);

      header.appendChild(hdDot);
      header.appendChild(hdName);
      holder.appendChild(header);

      const existing = byPlayer[pid] || {};

      holder.appendChild(rowField('Birdies', 'birdies', existing.birdies, 99));
      holder.appendChild(rowField('Eagles', 'eagles', existing.eagles, 99));
      holder.appendChild(rowField('Albatross', 'albatross', existing.albatross, 99));
      holder.appendChild(rowField('HIO', 'hio', existing.hio, 99));
      holder.appendChild(rowField('Närmast flagg', 'ctp', existing.ctp, 99));
      holder.appendChild(rowField('Längsta drive', 'ld', existing.ld, 99));

      right.appendChild(holder);
      item.appendChild(right);
      bookPlayersList.appendChild(item);
    });

    openModal(bookModal);
    setTimeout(() => closeMatchBtn.focus(), 0);
  }

  function openEditTeam(id){
    const state = load();
    const t = state.teams.find(x => x.id === id);
    if(!t) return;

    editingTeamId = id;
    teamModalTitle.textContent = 'Ändra lag';
    teamName.value = t.name || '';
    teamColor.value = t.color || '#7c1d1d';
    openModal(teamModal);
    setTimeout(() => teamName.focus(), 0);
  }

  function openEditPlayer(id){
    const state = load();
    const p = state.players.find(x => x.id === id);
    if(!p) return;

    editingPlayerId = id;
    playerModalTitle.textContent = 'Ändra spelare';
    playerName.value = p.name || '';
    openModal(playerModal);
    setTimeout(() => playerName.focus(), 0);
  }

  function openAddPlayerForTeam(teamId){
    const state = load();
    const t = state.teams.find(x => x.id === teamId);

    addingPlayerTeamId = teamId || '';
    editingPlayerId = null;

    playerModalTitle.textContent = t ? `Lägg till spelare – ${t.name}` : 'Lägg till spelare';
    playerName.value = '';

    openModal(playerModal);
    setTimeout(() => playerName.focus(), 0);
  }

  function openEditRound(roundId){
    const state = load();
    const r = state.rounds.find(x => x.id === roundId);
    if(!r) return;

    editingRoundId = roundId;
    roundModalTitle.textContent = 'Ändra runda';
    roundDate.value = r.date || '';
    roundCourse.value = r.course || '';
    openModal(roundModal);
    setTimeout(() => roundCourse.focus(), 0);
  }

  function deleteTeam(id){
    const state = load();
    const team = state.teams.find(t => t.id === id);
    if(!team) return;
    if(!confirm('Ta bort "' + team.name + '" + alla spelare i laget?')) return;

    const removedPlayerIds = new Set(
      (state.players || []).filter(p => p.teamId === id).map(p => p.id)
    );

    state.teams = (state.teams || []).filter(t => t.id !== id);
    state.players = (state.players || []).filter(p => !removedPlayerIds.has(p.id));

    state.matches = Array.isArray(state.matches) ? state.matches : [];
    state.matches.forEach(m => {
      if(!m) return;

      m.teamA = (Array.isArray(m.teamA) ? m.teamA : []).filter(pid => !removedPlayerIds.has(pid));
      m.teamB = (Array.isArray(m.teamB) ? m.teamB : []).filter(pid => !removedPlayerIds.has(pid));

      if(m.book && m.book.byPlayer && typeof m.book.byPlayer === 'object'){
        for(const pid of removedPlayerIds) delete m.book.byPlayer[pid];
      }

      const aOk = (m.teamA || []).length > 0;
      const bOk = (m.teamB || []).length > 0;
      if(!aOk || !bOk){
        m.isClosed = false;
        m.holes = Array(18).fill(null);
        delete m.book;
      }
    });

    const clean = sanitizeState(state);
    save(clean);
    render(clean);
  }

  function deletePlayer(id){
    const state = load();
    const player = state.players.find(p => p.id === id);
    if(!player) return;
    if(!confirm('Ta bort "' + player.name + '"?')) return;

    state.players = state.players.filter(p => p.id !== id);

    state.matches = Array.isArray(state.matches) ? state.matches : [];
    state.matches.forEach(m => {
      if(!m) return;

      m.teamA = (Array.isArray(m.teamA) ? m.teamA : []).filter(pid => pid !== id);
      m.teamB = (Array.isArray(m.teamB) ? m.teamB : []).filter(pid => pid !== id);

      if(m.book && m.book.byPlayer && typeof m.book.byPlayer === 'object'){
        delete m.book.byPlayer[id];
      }

      const aOk = (m.teamA || []).length > 0;
      const bOk = (m.teamB || []).length > 0;

      if(!aOk || !bOk){
        m.isClosed = false;
        m.holes = Array(18).fill(null);
        delete m.book;
      }
    });

    const clean = sanitizeState(state);
    save(clean);
    render(clean);
  }

  function deleteRound(roundId){
    const state = load();
    const r = state.rounds.find(x => x.id === roundId);
    if(!r) return;

    const label = (formatDate(r.date) ? formatDate(r.date) + ' – ' : '') + (r.course || '');
    if(!confirm('Ta bort "' + label + '"?')) return;

    state.rounds = state.rounds.filter(x => x.id !== roundId);
    state.matches = (state.matches || []).filter(m => m.roundId !== roundId);
    save(state);
    render(state);
  }

  function renumberMatches(state){
    const roundsSorted = [...state.rounds].sort((a,b) => (a.date || '').localeCompare(b.date || ''));
    const matches = Array.isArray(state.matches) ? state.matches : [];

    let n = 1;
    let changed = false;

    roundsSorted.forEach(r => {
      matches.filter(m => m.roundId === r.id).forEach(m => {
        if(Number(m.no) !== n){
          m.no = n;
          changed = true;
        }
        n++;
      });
    });

    return changed;
  }

  matchType.addEventListener('change', updateMatchUI);

  saveMatchBtn.addEventListener('click', () => {
    const state = load();
    sortTeamsAndPlayers2Lag(state);

    state.matches = Array.isArray(state.matches) ? state.matches : [];

    const type = matchType.value;
    const value = parseInt(matchValue.value, 10);

    const a1 = (teamAPlayer1.value || '').trim();
    const b1 = (teamBPlayer1.value || '').trim();
    const isPar = type === 'Par';
    const a2 = isPar ? (teamAPlayer2.value || '').trim() : '';
    const b2 = isPar ? (teamBPlayer2.value || '').trim() : '';

    if(!currentMatchRoundId) return;

    if(editingMatchId){
      const mm = state.matches.find(x => x.id === editingMatchId);
      if(!mm || mm.isClosed) return;

      mm.type = type;
      mm.value = value;
      mm.teamA = isPar ? [a1, a2] : [a1];
      mm.teamB = isPar ? [b1, b2] : [b1];
    }else{
      state.matches.push({
        id: uid(),
        no: nextMatchNo(state),
        roundId: currentMatchRoundId,
        type,
        value,
        teamA: isPar ? [a1, a2] : [a1],
        teamB: isPar ? [b1, b2] : [b1],
        holes: Array(18).fill(null)
      });
    }

    save(state);
    render(state);
    closeModal(matchModal);
    editingMatchId = null;
  });

  document.getElementById('addTeamBtn').addEventListener('click', () => {
    const state = load();
    if((state.teams || []).length >= 2){
      alert('Max 2 lag. Ta bort ett lag om du vill byta.');
      return;
    }
    editingTeamId = null;
    teamModalTitle.textContent = 'Lägg till lag';
    teamName.value = '';
    teamColor.value = '#7c1d1d';
    openModal(teamModal);
    setTimeout(() => teamName.focus(), 0);
  });

  document.getElementById('addRoundBtn').addEventListener('click', () => {
    editingRoundId = null;
    roundModalTitle.textContent = 'Lägg till runda';
    roundDate.value = '';
    roundCourse.value = '';
    openModal(roundModal);
    setTimeout(() => roundCourse.focus(), 0);
  });

  const toggleAllTeamsBtn = document.getElementById('toggleAllTeamsBtn');
  if(toggleAllTeamsBtn){
    toggleAllTeamsBtn.addEventListener('click', () => {
      const state = load();
      const mode = toggleAllTeamsBtn.dataset.mode || 'collapse';
      setAllTeamsOpen(state, mode === 'expand');
      render(state);
    });
  }

  const toggleAllRoundsBtn = document.getElementById('toggleAllRoundsBtn');
  if(toggleAllRoundsBtn){
    toggleAllRoundsBtn.addEventListener('click', () => {
      const state = load();
      const mode = toggleAllRoundsBtn.dataset.mode || 'collapse';
      setAllRoundsOpen(state, mode === 'expand');
      render(state);
    });
  }

  saveTeamBtn.addEventListener('click', () => {
    const name = teamName.value.trim();
    if(!name) return;

    const state = load();
    state.teams = Array.isArray(state.teams) ? state.teams : [];

    if(!editingTeamId && state.teams.length >= 2){
      alert('Max 2 lag. Ta bort ett lag om du vill byta.');
      return;
    }

    const color = teamColor.value || '#7c1d1d';

    if(editingTeamId){
      const t = state.teams.find(x => x.id === editingTeamId);
      if(!t) return;
      t.name = name;
      t.color = color;
    }else{
      state.teams.push({id:uid(), name, color});
    }

    save(state);
    render(state);
    closeModal(teamModal);
  });

  savePlayerBtn.addEventListener('click', () => {
    const name = playerName.value.trim();
    if(!name) return;

    const state = load();
    state.players = Array.isArray(state.players) ? state.players : [];

    if(editingPlayerId){
      const p = state.players.find(x => x.id === editingPlayerId);
      if(!p) return;
      p.name = name;
    }else{
      state.players.push({
        id: uid(),
        name,
        teamId: addingPlayerTeamId || '',
        isCaptain: false
      });
    }

    save(state);
    render(state);
    closeModal(playerModal);
    addingPlayerTeamId = '';
  });

  saveRoundBtn.addEventListener('click', () => {
    const date = (roundDate.value || '').trim();
    const course = roundCourse.value.trim();
    if(!date || !course) return;

    const state = load();
    state.rounds = Array.isArray(state.rounds) ? state.rounds : [];

    if(editingRoundId){
      const r = state.rounds.find(x => x.id === editingRoundId);
      if(!r) return;
      r.date = date;
      r.course = course;
    }else{
      state.rounds.push({id:uid(), date, course});
    }

    save(state);
    render(state);
    closeModal(roundModal);
  });

  function collectBookDataIntoMatch(m){
    m.book = m.book || {};

    const byPlayer = {};
    const holders = bookPlayersList.querySelectorAll('[data-player]');
    holders.forEach(h => {
      const pid = h.getAttribute('data-player');
      if(!pid) return;

      const stats = {};
      h.querySelectorAll('input[data-stat]').forEach(inp => {
        const key = inp.getAttribute('data-stat');
        const max = parseInt(inp.getAttribute('data-max') || '999', 10);
        let val = parseInt(inp.value, 10);
        if(isNaN(val)) val = 0;
        if(val < 0) val = 0;
        if(val > max) val = max;
        inp.value = String(val);
        stats[key] = val;
      });

      byPlayer[pid] = {
        birdies: stats.birdies || 0,
        eagles: stats.eagles || 0,
        albatross: stats.albatross || 0,
        hio: stats.hio || 0,
        ctp: stats.ctp || 0,
        ld: stats.ld || 0
      };
    });

    m.book.byPlayer = byPlayer;

    if(Array.isArray(bookingHolesDraft) && bookingHolesDraft.length === 18){
      m.holes = cloneHoles(bookingHolesDraft);

      const anyPlayed = m.holes.some(v => v === 'A' || v === 'B' || v === 'H');
      if(anyPlayed){
        const outcome = computeOutcomeFromHoles(m.holes);
        if(outcome.decided){
          m.book.winner = outcome.winner;
          m.book.wonOnHole = (outcome.winner === 'D') ? '' : String(outcome.wonOnHole || '');
          m.book.resultUp = outcome.resultUp || 0;
        }else{
          m.book.winner = '';
          m.book.wonOnHole = '';
          m.book.resultUp = 0;
        }
      }
    }
  }

  saveBookBtn.addEventListener('click', () => {
    const state = load();
    const m = (state.matches || []).find(x => x.id === bookingMatchId);
    if(!m || m.isClosed) return;

    collectBookDataIntoMatch(m);
    save(state);
    render(state);
    closeModal(bookModal);
  });

  closeMatchBtn.addEventListener('click', () => {
    const state = load();
    const m = (state.matches || []).find(x => x.id === bookingMatchId);
    if(!m || m.isClosed) return;

    collectBookDataIntoMatch(m);
    m.isClosed = true;

    save(state);
    render(state);
    closeModal(bookModal);
  });

  const tPlayers = document.getElementById('tab-players');
  const tComp = document.getElementById('tab-competition');

  const pPlayers = document.getElementById('panel-players');
  const pComp = document.getElementById('panel-competition');

  function setTab(which){
    const isPlayers = which === 'players';
    const isComp = which === 'comp';

    tPlayers.classList.toggle('is-active', isPlayers);
    tComp.classList.toggle('is-active', isComp);

    tPlayers.setAttribute('aria-selected', isPlayers ? 'true' : 'false');
    tComp.setAttribute('aria-selected', isComp ? 'true' : 'false');

    pPlayers.classList.toggle('is-active', isPlayers);
    pComp.classList.toggle('is-active', isComp);

    const lagStatsBlock = document.getElementById('lagStatsBlock');
    const playerStatsBlock = document.getElementById('playerStatsBlock');

    if(lagStatsBlock) lagStatsBlock.style.display = isComp ? '' : 'none';
    if(playerStatsBlock) playerStatsBlock.style.display = isComp ? '' : 'none';
    if(competitionInfoBlock) competitionInfoBlock.style.display = isComp ? '' : 'none';
  }

  tPlayers.addEventListener('click', () => setTab('players'));
  tComp.addEventListener('click', () => setTab('comp'));

  function fmtPts(x){
    const n = Number(x) || 0;
    return (n % 1 === 0) ? String(n) : n.toFixed(1).replace('.', ',');
  }

  function computeTeamStats(state){
    const teams = Array.isArray(state.teams) ? state.teams : [];
    const { A: teamA, B: teamB } = getTeamsAB(state);

    const ts = {};
    teams.forEach(t => ts[t.id] = { SM:0, W:0, S:0, L:0, D:0, PM:0, P:0 });

    if(!teamA || !teamB) return { teams, ts, leadingTeamId: '' };

    const A = ts[teamA.id];
    const B = ts[teamB.id];
    const matches = Array.isArray(state.matches) ? state.matches : [];

    matches.forEach(m => {
      if(!m?.isClosed) return;
      const res = getClosedWinnerAndHole(m);

      A.SM += 1;
      B.SM += 1;

      applyTeamResult(A, B, res.winner, res.wonOnHole, m.type);
    });

    let leadingTeamId = '';

    if(A.P > B.P) leadingTeamId = teamA.id;
    else if(B.P > A.P) leadingTeamId = teamB.id;
    else if(A.PM > B.PM) leadingTeamId = teamA.id;
    else if(B.PM > A.PM) leadingTeamId = teamB.id;
    else{
      const aSingles = (A.S || 0);
      const bSingles = (B.S || 0);
      if(aSingles > bSingles) leadingTeamId = teamA.id;
      else if(bSingles > aSingles) leadingTeamId = teamB.id;
      else leadingTeamId = '';
    }

    return { teams, ts, leadingTeamId };
  }

  function renderLagStats(state){
    const body = document.getElementById('lagStatsBody');
    if(!body) return;

    body.innerHTML = '';

    const { teams, ts } = computeTeamStats(state);

    if(teams.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.textContent = 'Inga lag skapade ännu.';
      td.style.textAlign = 'left';
      td.style.color = 'var(--muted)';
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    function fmtTeamPts(x){
      return (x % 1 === 0) ? String(x) : x.toFixed(1).replace('.', ',');
    }

    teams.forEach(t => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const dot = document.createElement('span');
      dot.className = 'team-dot';
      dot.style.background = t.color || 'rgba(255,255,255,.22)';
      const name = document.createElement('span');
      name.textContent = t.name || '';
      tdName.appendChild(dot);
      tdName.appendChild(name);
      tr.appendChild(tdName);

      const s = ts[t.id] || {SM:0,W:0,S:0,L:0,D:0,PM:0,P:0};

      const cells = [
        s.SM || 0,
        s.W,
        s.S || 0,
        s.D,
        s.L,
        s.PM,
        fmtTeamPts(s.P)
      ];
      cells.forEach(v => {
        const td = document.createElement('td');
        td.textContent = String(v);
        tr.appendChild(td);
      });

      body.appendChild(tr);
    });
  }

  function computeTeamTotalsForFF(state){
    const { leadingTeamId } = computeTeamStats(state);
    return { leadingTeamId: leadingTeamId || '' };
  }

  function computePlayerStats(state){
    const players = Array.isArray(state.players) ? state.players.slice() : [];
    players.sort((a,b) => (a.name||'').localeCompare(b.name||'', 'sv'));

    const ps = {};
    players.forEach(p => {
      ps[p.id] = { SM:0, PV:0, SV:0, F:0, D:0, B:0, E:0, A:0, HIO:0, NF:0, LD:0, P:0, FF:0 };
    });

    const matchesAll = Array.isArray(state.matches) ? state.matches : [];

    const W_BIRDIE = 1.5;
    const W_EAGLE = 3.5;
    const W_ALBATROSS = 30;
    const W_HIO = 20;
    const W_NF = 1.5;
    const W_LD = 1.5;

    matchesAll.forEach(m => {
      if(!m || !m.isClosed) return;

      const res = getClosedWinnerAndHole(m);
      const winner = res.winner;
      if(!winner) return;

      const value = Number(m.value) || 0;

      const teamA = Array.isArray(m.teamA) ? m.teamA.filter(Boolean) : [];
      const teamB = Array.isArray(m.teamB) ? m.teamB.filter(Boolean) : [];
      const playersInMatch = [...teamA, ...teamB];

      playersInMatch.forEach(pid => { if(ps[pid]) ps[pid].SM += 1; });

      if(winner === 'A' || winner === 'B'){
        const winners = (winner === 'A') ? teamA : teamB;
        const losers  = (winner === 'A') ? teamB : teamA;

        losers.forEach(pid => { if(ps[pid]) ps[pid].F += 1; });

        winners.forEach(pid => {
          if(!ps[pid]) return;
          if(m.type === 'Par') ps[pid].PV += 1;
          else ps[pid].SV += 1;
          ps[pid].P += value;
        });
      }else if(winner === 'D'){
        const share = value / 2;
        playersInMatch.forEach(pid => {
          if(!ps[pid]) return;
          ps[pid].D += 1;
          ps[pid].P += share;
        });
      }

      const byPlayer = (m.book && m.book.byPlayer && typeof m.book.byPlayer === 'object') ? m.book.byPlayer : {};
      playersInMatch.forEach(pid => {
        if(!ps[pid]) return;
        const s = byPlayer[pid] || {};

        const birdies = Number(s.birdies) || 0;
        const eagles = Number(s.eagles) || 0;
        const albatross = Number(s.albatross) || 0;
        const hio = Number(s.hio) || 0;
        const nf = Number(s.ctp) || 0;
        const ld = Number(s.ld) || 0;

        ps[pid].B += birdies;
        ps[pid].E += eagles;
        ps[pid].A += albatross;
        ps[pid].HIO += hio;
        ps[pid].NF += nf;
        ps[pid].LD += ld;

        ps[pid].P += (birdies * W_BIRDIE)
                  + (eagles * W_EAGLE)
                  + (albatross * W_ALBATROSS)
                  + (hio * W_HIO)
                  + (nf * W_NF)
                  + (ld * W_LD);
      });
    });

    const leadingTeamId = computeTeamTotalsForFF(state).leadingTeamId;
    if(leadingTeamId){
      players.forEach(p => { if(p.teamId === leadingTeamId && ps[p.id]) ps[p.id].FF += -5; });
    }

    const ranked = players.slice().sort((a,b) => {
      const A = ps[a.id] || {};
      const B = ps[b.id] || {};

      const aP  = Number(A.P)  || 0;
      const bP  = Number(B.P)  || 0;
      const aSV = Number(A.SV) || 0;
      const bSV = Number(B.SV) || 0;
      const aPV = Number(A.PV) || 0;
      const bPV = Number(B.PV) || 0;
      const aD  = Number(A.D)  || 0;
      const bD  = Number(B.D)  || 0;
      const aB  = Number(A.B)  || 0;
      const bB  = Number(B.B)  || 0;
      const aE  = Number(A.E)  || 0;
      const bE  = Number(B.E)  || 0;
      const aAl = Number(A.A)  || 0;
      const bAl = Number(B.A)  || 0;
      const aH  = Number(A.HIO)|| 0;
      const bH  = Number(B.HIO)|| 0;

      const dir = -1;

      if(bP !== aP) return dir * (aP - bP);
      if(bSV !== aSV) return dir * (aSV - bSV);
      if(bPV !== aPV) return dir * (aPV - bPV);
      if(bAl !== aAl) return dir * (aAl - bAl);
      if(bH  !== aH)  return dir * (aH  - bH);
      if(bE  !== aE)  return dir * (aE  - bE);
      if(bB  !== aB)  return dir * (aB  - bB);

      const aM = aPV + aSV + aD;
      const bM = bPV + bSV + bD;
      if(aM !== bM) return aM - bM;

      return (a.name||'').localeCompare(b.name||'', 'sv');
    });

    const topFF = [-3, -2, -1];
    for(let i=0;i<3 && i<ranked.length;i++){
      const pid = ranked[i].id;
      if(ps[pid]) ps[pid].FF += topFF[i];
    }

    return { players, ps };
  }

  function renderPlayerStats(state){
    const body = document.getElementById('playerStatsBody');
    if(!body) return;

    body.innerHTML = '';

    const { players, ps } = computePlayerStats(state);

    if(players.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 14;
      td.textContent = 'Inga spelare skapade ännu.';
      td.style.textAlign = 'left';
      td.style.color = 'var(--muted)';
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    for(const p of players){
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const dot = document.createElement('span');
      dot.className = 'team-dot';
      dot.style.background = teamColorById(state, p.teamId);
      const nameSpan = document.createElement('span');
      nameSpan.textContent = p.name || '';
      tdName.appendChild(dot);
      tdName.appendChild(nameSpan);
      tr.appendChild(tdName);

      const s = ps[p.id] || { SM:0, PV:0, SV:0, F:0, D:0, B:0, E:0, A:0, HIO:0, NF:0, LD:0, P:0, FF:0 };

      const cols = [
        s.SM,
        s.PV,
        s.SV,
        s.D,
        s.F,
        s.B,
        s.E,
        s.A,
        s.HIO,
        s.NF,
        s.LD,
        fmtPts(s.P),
        s.FF
      ];
      cols.forEach(v => {
        const td = document.createElement('td');
        td.textContent = String(v);
        tr.appendChild(td);
      });

      body.appendChild(tr);
    }
  }

  function makeTableSortable(tableEl, defaultSortColIndex, opts = {}){
    if(!tableEl) return;

    const thead = tableEl.querySelector('thead');
    const tbody = tableEl.querySelector('tbody');
    if(!thead || !tbody) return;

    let sortState = { index: defaultSortColIndex, dir: -1 };

    const locale = opts.locale || 'sv';
    const tiebreakOnP = !!opts.tiebreakOnP;
    const mode = opts.mode || 'generic';
    const idx = opts.idx || {};

    function getCellText(tr, i){
      return tr.children[i]?.textContent.trim() || '';
    }

    function numFromCell(tr, i){
      const s = getCellText(tr, i).replace(/\s/g,'').replace(',', '.');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    function nameFromRow(tr){ return getCellText(tr, 0); }
    function cmpLocale(a,b){ return a.localeCompare(b, locale); }

    function cmpTeamByP(a, b, dir){
      const aP  = numFromCell(a, idx.P);
      const bP  = numFromCell(b, idx.P);
      if(aP !== bP) return dir * (aP - bP);

      const aPM = numFromCell(a, idx.PM);
      const bPM = numFromCell(b, idx.PM);
      if(aPM !== bPM) return dir * (aPM - bPM);

      const aSV = numFromCell(a, idx.SV);
      const bSV = numFromCell(b, idx.SV);
      if(aSV !== bSV) return dir * (aSV - bSV);

      const aPV = numFromCell(a, idx.PV);
      const bPV = numFromCell(b, idx.PV);
      if(aPV !== bPV) return dir * (aPV - bPV);

      return cmpLocale(nameFromRow(a), nameFromRow(b));
    }

    function cmpPlayerByP(a, b, dir){
      const aP  = numFromCell(a, idx.P);
      const bP  = numFromCell(b, idx.P);
      if(aP !== bP) return dir * (aP - bP);

      const aSV = numFromCell(a, idx.SV);
      const bSV = numFromCell(b, idx.SV);
      if(aSV !== bSV) return dir * (aSV - bSV);

      const aPV = numFromCell(a, idx.PV);
      const bPV = numFromCell(b, idx.PV);
      if(aPV !== bPV) return dir * (aPV - bPV);

      const aA  = numFromCell(a, idx.A);
      const bA  = numFromCell(b, idx.A);
      if(aA !== bA) return dir * (aA - bA);

      const aH  = numFromCell(a, idx.HIO);
      const bH  = numFromCell(b, idx.HIO);
      if(aH !== bH) return dir * (aH - bH);

      const aE  = numFromCell(a, idx.E);
      const bE  = numFromCell(b, idx.E);
      if(aE !== bE) return dir * (aE - bE);

      const aB  = numFromCell(a, idx.B);
      const bB  = numFromCell(b, idx.B);
      if(aB !== bB) return dir * (aB - bB);

      const aM = numFromCell(a, idx.PV) + numFromCell(a, idx.SV) + numFromCell(a, idx.D);
      const bM = numFromCell(b, idx.PV) + numFromCell(b, idx.SV) + numFromCell(b, idx.D);
      if(aM !== bM) return (-dir) * (aM - bM);

      return cmpLocale(nameFromRow(a), nameFromRow(b));
    }

    function sortRows(i, dir){
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a,b) => {
        if(tiebreakOnP && i === idx.P){
          if(mode === 'team')   return cmpTeamByP(a,b,dir);
          if(mode === 'player') return cmpPlayerByP(a,b,dir);
        }

        const av = getCellText(a, i);
        const bv = getCellText(b, i);

        const an = Number(av.replace(',', '.'));
        const bn = Number(bv.replace(',', '.'));

        const aIsNum = !isNaN(an);
        const bIsNum = !isNaN(bn);

        if(aIsNum && bIsNum) return dir * (an - bn);
        return dir * cmpLocale(av.toLowerCase(), bv.toLowerCase());
      });

      rows.forEach(r => tbody.appendChild(r));
    }

    Array.from(thead.querySelectorAll('th')).forEach((th, i) => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        if(sortState.index === i) sortState.dir *= -1;
        else { sortState.index = i; sortState.dir = -1; }
        sortRows(sortState.index, sortState.dir);
      });
    });

    sortRows(sortState.index, sortState.dir);
  }

  function enableStatTableSorting(){
    const lagTable = document.querySelector('#lagStatsBlock table');
    makeTableSortable(lagTable, 7, {
      tiebreakOnP: true,
      mode: 'team',
      idx: { SM:1, PV:2, SV:3, P:7, PM:6 }
    });

    const playerTable = document.querySelector('#playerStatsBlock table');
    makeTableSortable(playerTable, 12, {
      tiebreakOnP: true,
      mode: 'player',
      idx: { P:12, SV:3, PV:2, D:4, B:6, E:7, A:8, HIO:9 }
    });
  }

  function initCompetitionInfoEditor(){
    if(!competitionInfoEditor) return;

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.editor-btn[data-cmd]');
      if(!btn) return;

      const cmd = btn.getAttribute('data-cmd');
      const arg = btn.getAttribute('data-arg');

      competitionInfoEditor.focus();
      try{
        document.execCommand(cmd, false, arg || null);
      }catch(_){}
    });

    if(compInfoLinkBtn){
      compInfoLinkBtn.addEventListener('click', () => {
        competitionInfoEditor.focus();
        const url = prompt('Klistra in länk (https://...)');
        if(!url) return;
        try{ document.execCommand('createLink', false, url.trim()); }catch(_){}
      });
    }

    const compInfoFontSize = document.getElementById('compInfoFontSize');

    function applyFontSizeToSelection(sizePx){
      if(!competitionInfoEditor) return;

      competitionInfoEditor.focus();

      const sel = window.getSelection();
      if(!sel || sel.rangeCount === 0) return;
      const range = sel.getRangeAt(0);

      if(!competitionInfoEditor.contains(range.commonAncestorContainer)) return;

      if(range.collapsed){
        const span = document.createElement('span');
        span.style.fontSize = sizePx;
        span.appendChild(document.createTextNode('\u200B'));
        range.insertNode(span);

        range.setStart(span.firstChild, 1);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
        return;
      }

      const span = document.createElement('span');
      span.style.fontSize = sizePx;

      try{
        range.surroundContents(span);
      }catch(e){
        const frag = range.extractContents();
        span.appendChild(frag);
        range.insertNode(span);
      }

      sel.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNodeContents(span);
      sel.addRange(newRange);
    }

    if(compInfoFontSize){
      compInfoFontSize.addEventListener('change', () => {
        const v = compInfoFontSize.value;
        if(!v) return;
        applyFontSizeToSelection(v);
        compInfoFontSize.value = '';
      });
    }

    if(compInfoSaveBtn){
      compInfoSaveBtn.addEventListener('click', () => {
        const state = load();
        state.competitionInfoHtml = competitionInfoEditor.innerHTML || '';
        save(state);
      });
    }

    if(compInfoClearBtn){
      compInfoClearBtn.addEventListener('click', () => {
        if(!confirm('Rensa tävlingsinformationen?')) return;
        competitionInfoEditor.innerHTML = '';
        const state = load();
        state.competitionInfoHtml = '';
        save(state);
      });
    }
  }

  function render(state){
    state = sanitizeState(state);
    teamList.innerHTML = '';
    roundList.innerHTML = '';

    state.rounds = Array.isArray(state.rounds) ? state.rounds.slice() : [];
    state.rounds.sort((a,b) => (a.date || '').localeCompare(b.date || ''));

    state.matches = Array.isArray(state.matches) ? state.matches : [];
    if(renumberMatches(state)) save(state);

    sortTeamsAndPlayers2Lag(state);

    renderPlayerStats(state);
    renderLagStats(state);

    if(competitionInfoEditor){
      competitionInfoEditor.innerHTML = state.competitionInfoHtml || '';
    }

    if(state.teams.length === 0){
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.style.textAlign = 'center';
      empty.style.padding = '10px 0';
      empty.textContent = 'Inga lag skapade.';
      teamList.appendChild(empty);
    }else{
      state.teams.forEach(t => {
        const item = document.createElement('div');
        item.className = 'item';

        const left = document.createElement('div');
        left.className = 'left';

        const dot = document.createElement('span');
        dot.className = 'dot';
        dot.style.background = t.color || 'rgba(255,255,255,.22)';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = t.name;

        left.appendChild(dot);
        left.appendChild(name);

        const right = document.createElement('div');
        right.className = 'right';

        const toggleTeam = document.createElement('button');
        toggleTeam.className = 'btn small';
        toggleTeam.type = 'button';
        toggleTeam.textContent = isTeamOpen(t.id) ? 'Dölj' : 'Visa';
        toggleTeam.addEventListener('click', () => {
          expandedTeams[t.id] = !isTeamOpen(t.id);
          render(load());
        });

        const addP = document.createElement('button');
        addP.className = 'btn small';
        addP.type = 'button';
        addP.textContent = 'Lägg till spelare';
        addP.addEventListener('click', () => openAddPlayerForTeam(t.id));

        const edit = document.createElement('button');
        edit.className = 'btn small';
        edit.type = 'button';
        edit.textContent = 'Ändra';
        edit.addEventListener('click', () => openEditTeam(t.id));

        const del = document.createElement('button');
        del.className = 'btn danger small';
        del.type = 'button';
        del.textContent = 'Ta bort';
        del.addEventListener('click', () => deleteTeam(t.id));

        right.appendChild(toggleTeam);
        right.appendChild(addP);
        right.appendChild(edit);
        right.appendChild(del);

        item.appendChild(left);
        item.appendChild(right);
        teamList.appendChild(item);

        const teamChildrenWrap = document.createElement('div');
        teamChildrenWrap.style.display = isTeamOpen(t.id) ? '' : 'none';
        teamChildrenWrap.style.marginTop = '6px';
        teamList.appendChild(teamChildrenWrap);

        const teamPlayers = state.players
          .filter(p => p.teamId === t.id)
          .slice()
          .sort((a,b) => {
            if(!!a.isCaptain !== !!b.isCaptain) return a.isCaptain ? -1 : 1;
            return (a.name||'').localeCompare(b.name||'','sv');
          });

        if(teamPlayers.length === 0){
          const pi = document.createElement('div');
          pi.className = 'item';
          pi.style.marginLeft = '22px';
          pi.style.borderColor = 'rgba(255,255,255,.08)';
          pi.style.background = 'rgba(0,0,0,.10)';

          const txt = document.createElement('div');
          txt.style.color = 'var(--muted)';
          txt.style.fontWeight = '600';
          txt.textContent = 'Inga spelare i laget ännu.';

          pi.appendChild(txt);
          teamChildrenWrap.appendChild(pi);
        }else{
          teamPlayers.forEach(p => {
            const pi = document.createElement('div');
            pi.className = 'item';
            pi.style.marginLeft = '22px';
            pi.style.borderColor = 'rgba(255,255,255,.08)';
            pi.style.background = 'rgba(255,255,255,.08)';
            pi.style.marginTop = '10px';

            const pl = document.createElement('div');
            pl.className = 'left';

            const nm = document.createElement('div');
            nm.className = 'name';
            nm.textContent = (p.name || '') + (p.isCaptain ? ' 👑' : '');
            pl.appendChild(nm);

            const pr = document.createElement('div');
            pr.className = 'right';

            const cap = document.createElement('button');
            cap.className = 'btn small';
            cap.type = 'button';
            cap.textContent = 'Kapten';
            cap.addEventListener('click', () => {
              const s2 = load();
              s2.players.forEach(x => { if(x.teamId === p.teamId) x.isCaptain = false; });
              const pp = s2.players.find(x => x.id === p.id);
              if(pp) pp.isCaptain = true;
              save(s2);
              render(s2);
            });

            const editP = document.createElement('button');
            editP.className = 'btn small';
            editP.type = 'button';
            editP.textContent = 'Ändra';
            editP.addEventListener('click', () => openEditPlayer(p.id));

            const delP = document.createElement('button');
            delP.className = 'btn danger small';
            delP.type = 'button';
            delP.textContent = 'Ta bort';
            delP.addEventListener('click', () => deletePlayer(p.id));

            pr.appendChild(cap);
            pr.appendChild(editP);
            pr.appendChild(delP);

            pi.appendChild(pl);
            pi.appendChild(pr);
            teamChildrenWrap.appendChild(pi);
          });
        }
      });
    }

    if(state.rounds.length === 0){
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.style.textAlign = 'center';
      empty.style.padding = '10px 0';
      empty.textContent = 'Inga ronder skapade.';
      roundList.appendChild(empty);
    }else{
      const matches = Array.isArray(state.matches) ? state.matches : [];

      state.rounds.forEach(r => {
        const item = document.createElement('div');
        item.className = 'item';

        const left = document.createElement('div');
        left.className = 'left';

        const roundNo = state.rounds.findIndex(x => x.id === r.id) + 1;

        const name = document.createElement('div');
        name.className = 'name';
        name.style.display = 'flex';
        name.style.alignItems = 'baseline';
        name.style.gap = '10px';
        name.style.flexWrap = 'wrap';

        const roundStrong = document.createElement('span');
        roundStrong.textContent = `Runda ${roundNo}`;
        roundStrong.style.fontWeight = '900';

        const courseSpan = document.createElement('span');
        courseSpan.textContent = r.course || '';
        courseSpan.style.fontWeight = '700';

        const dateSpan = document.createElement('span');
        dateSpan.textContent = formatDate(r.date) || '';
        dateSpan.style.color = 'var(--muted)';
        dateSpan.style.fontWeight = '600';

        name.appendChild(roundStrong);
        if(r.course) name.appendChild(courseSpan);
        if(r.date) name.appendChild(dateSpan);

        left.appendChild(name);

        const right = document.createElement('div');
        right.className = 'right';

        const toggleRound = document.createElement('button');
        toggleRound.className = 'btn small';
        toggleRound.type = 'button';
        toggleRound.textContent = isRoundOpen(r.id) ? 'Dölj' : 'Visa';
        toggleRound.addEventListener('click', () => {
          expandedRounds[r.id] = !isRoundOpen(r.id);
          render(load());
        });

        const addMatch = document.createElement('button');
        addMatch.className = 'btn small';
        addMatch.type = 'button';
        addMatch.textContent = 'Lägg till Match';
        addMatch.addEventListener('click', () => openAddMatchForRound(r.id));

        const edit = document.createElement('button');
        edit.className = 'btn small';
        edit.type = 'button';
        edit.textContent = 'Ändra';
        edit.addEventListener('click', () => openEditRound(r.id));

        const del = document.createElement('button');
        del.className = 'btn danger small';
        del.type = 'button';
        del.textContent = 'Ta bort';
        del.addEventListener('click', () => deleteRound(r.id));

        right.appendChild(toggleRound);
        right.appendChild(addMatch);
        right.appendChild(edit);
        right.appendChild(del);

        item.appendChild(left);
        item.appendChild(right);
        roundList.appendChild(item);

        const roundChildrenWrap = document.createElement('div');
        roundChildrenWrap.style.display = isRoundOpen(r.id) ? '' : 'none';
        roundChildrenWrap.style.marginTop = '6px';
        roundList.appendChild(roundChildrenWrap);

        const roundMatches = matches.filter(m => m.roundId === r.id);
        roundMatches.forEach(m => {
          const mi = document.createElement('div');
          mi.className = 'item';
          mi.style.marginLeft = '22px';
          mi.style.borderColor = 'rgba(255,255,255,.08)';
          mi.style.marginTop = '10px';

          const hasPlayers =
            (Array.isArray(m.teamA) && m.teamA.some(Boolean)) ||
            (Array.isArray(m.teamB) && m.teamB.some(Boolean));

          if(m.isClosed === true) mi.style.background = 'rgba(255,0,0,.20)';
          else if(hasPlayers) mi.style.background = 'rgba(22,163,74,.18)';
          else mi.style.background = 'rgba(255,255,255,.08)';

          const ml = document.createElement('div');
          ml.className = 'left';

          const matchNo = Number(m.no);

          const aTeamId = m.teamA && m.teamA[0] ? (state.players.find(p => p.id === m.teamA[0])?.teamId || '') : '';
          const bTeamId = m.teamB && m.teamB[0] ? (state.players.find(p => p.id === m.teamB[0])?.teamId || '') : '';

          const aColor = aTeamId ? teamColorById(state, aTeamId) : 'rgba(255,255,255,.22)';
          const bColor = bTeamId ? teamColorById(state, bTeamId) : 'rgba(255,255,255,.22)';

          const aNames = (m.teamA || []).map(pid => playerNameById(state, pid)).filter(Boolean).join(' / ');
          const bNames = (m.teamB || []).map(pid => playerNameById(state, pid)).filter(Boolean).join(' / ');

          const lines = document.createElement('div');
          lines.style.display = 'flex';
          lines.style.flexDirection = 'column';
          lines.style.gap = '6px';
          lines.style.minWidth = '0';

          const line1 = document.createElement('div');
          line1.style.display = 'flex';
          line1.style.alignItems = 'center';
          line1.style.gap = '10px';
          line1.style.minWidth = '0';
          line1.style.flexWrap = 'wrap';

          const t1 = document.createElement('div');
          t1.className = 'name';
          t1.style.fontWeight = '700';
          t1.style.display = 'flex';
          t1.style.alignItems = 'baseline';
          t1.style.gap = '10px';
          t1.style.flexWrap = 'wrap';

          const strongNo = document.createElement('span');
          strongNo.textContent = `Match ${matchNo}`;
          strongNo.style.fontWeight = '900';

          const meta = document.createElement('span');
          const typeLabel = m.type === 'Par' ? 'Bästboll' : 'Singel';
          meta.textContent = `${typeLabel} • Individuellt värde ${m.value}`;
          meta.style.color = 'var(--muted)';
          meta.style.fontWeight = '600';

          t1.appendChild(strongNo);
          t1.appendChild(meta);

          line1.appendChild(t1);

          const res = getClosedWinnerAndHole(m);
          if(res.winner === 'A' || res.winner === 'B' || res.winner === 'D'){
            const aTeamName = aTeamId ? (state.teams.find(t => t.id === aTeamId)?.name || 'Lag A') : 'Lag A';
            const bTeamName = bTeamId ? (state.teams.find(t => t.id === bTeamId)?.name || 'Lag B') : 'Lag B';

            const win = document.createElement('div');
            win.style.whiteSpace = 'nowrap';
            win.style.fontWeight = '900';
            win.style.fontSize = '1.02rem';
            win.style.letterSpacing = '.2px';

            if(res.winner === 'D'){
              win.style.color = 'var(--muted)';
              win.textContent = '• Delad match';
              win.style.fontWeight = '800';
              win.style.fontSize = '.98rem';
            }else{
              const isA = res.winner === 'A';
              const winTeamName = isA ? aTeamName : bTeamName;
              const winColor = isA ? aColor : bColor;
              const hole = res.wonOnHole || 0;
              const up = res.resultUp || (hole ? ((18 - hole) + 1) : 0);

              let mp = '';
              if(hole && up){
                if(hole === 18) mp = ` (${up}up)`;
                else mp = ` (${up}&${18 - hole})`;
              }

              win.style.color = winColor;
              win.textContent = `${winTeamName}` + (hole ? ` - Avgjord på hål ${hole}${mp}` : '');
            }
            line1.appendChild(win);
          }

          const line2 = document.createElement('div');
          line2.style.display = 'flex';
          line2.style.alignItems = 'center';
          line2.style.gap = '10px';
          line2.style.minWidth = '0';

          const mdA = document.createElement('span');
          mdA.className = 'dot';
          mdA.style.background = aColor;

          const tA = document.createElement('div');
          tA.className = 'name';
          tA.style.fontWeight = '600';
          tA.textContent = aNames;

          const vs = document.createElement('div');
          vs.style.color = 'var(--muted)';
          vs.style.fontWeight = '600';
          vs.textContent = 'vs';

          const mdB = document.createElement('span');
          mdB.className = 'dot';
          mdB.style.background = bColor;

          const tB = document.createElement('div');
          tB.className = 'name';
          tB.style.fontWeight = '600';
          tB.textContent = bNames;

          line2.appendChild(mdA);
          line2.appendChild(tA);
          line2.appendChild(vs);
          line2.appendChild(mdB);
          line2.appendChild(tB);

          lines.appendChild(line1);
          lines.appendChild(line2);

          if(Array.isArray(m.holes) && m.holes.length === 18){
            const line3 = document.createElement('div');
            line3.style.display = 'flex';
            line3.style.alignItems = 'center';
            line3.style.gap = '10px';
            line3.style.minWidth = '0';
            line3.style.flexWrap = 'wrap';

            const resText = document.createElement('div');
            resText.style.color = 'var(--muted)';
            resText.style.fontWeight = '600';
            resText.style.whiteSpace = 'nowrap';
            resText.textContent = `Resultat: ${computeMatchResultText(m.holes)}`;

            line3.appendChild(resText);
            line3.appendChild(makeHoleRow(m.holes, aColor, bColor));
            lines.appendChild(line3);
          }

          ml.appendChild(lines);

          const mr = document.createElement('div');
          mr.className = 'right';

          const book = document.createElement('button');
          book.className = 'btn small';
          book.type = 'button';
          book.textContent = 'Bokför';
          book.addEventListener('click', () => openBookMatch(m.id));

          const edit = document.createElement('button');
          edit.className = 'btn small';
          edit.type = 'button';
          edit.textContent = 'Ändra';
          edit.addEventListener('click', () => openEditMatch(m.id));

          const reopen = document.createElement('button');
          reopen.className = 'btn small';
          reopen.type = 'button';
          reopen.textContent = 'Öppna match';
          reopen.addEventListener('click', () => {
            if(!confirm('Öppna matchen igen?\n\nDetta gör att matchen räknas som ej avslutad och påverkar statistik igen när du avslutar på nytt.')) return;

            const s2 = load();
            const mm = (s2.matches || []).find(x => x.id === m.id);
            if(!mm) return;

            mm.isClosed = false;
            save(s2);
            render(s2);
          });

          const del = document.createElement('button');
          del.className = 'btn danger small';
          del.type = 'button';
          del.textContent = 'Ta bort';
          del.addEventListener('click', () => {
            if(!confirm('Ta bort matchen?')) return;
            const s2 = load();
            s2.matches = (s2.matches || []).filter(x => x.id !== m.id);
            save(s2);
            render(s2);
          });

          if(m.isClosed === true){
            mr.appendChild(reopen);
            mr.appendChild(del);
          }else{
            mr.appendChild(book);
            mr.appendChild(edit);
            mr.appendChild(del);
          }

          mi.appendChild(ml);
          mi.appendChild(mr);
          roundChildrenWrap.appendChild(mi);
        });
      });
    }

    syncToggleButtons(state);
    enableStatTableSorting();
  }

  const initial = load();
  save(initial);
  initCompetitionInfoEditor();
  render(initial);
})();
</script>
</body>
</html>